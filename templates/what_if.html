{% extends 'base.html' %}
{% load static %}

{% block title %} What-If Analysis {% endblock %}

{% block extra_head %}
<!-- Link to external CSS -->
<link rel="stylesheet" href="{% static 'style/search.css' %}">
{% endblock %}

{% block content %}
    {% if user.is_authenticated %}

        {% include 'navbar.html' %}

        <div class="container mt-4">
            <h1>What-If Investment Analysis</h1>
            <p>See how much your investment would be worth today if you had invested on a past date.</p>

            <!-- Form for user input -->
            <form method="get" class="mb-4">
                <div class="row">
                    <div class="col-md-3">
                        <input name="symbol" type="text" id="stock-search" class="form-control" placeholder="Search for stocks (e.g., Tesla, Apple, MSFT)" value="{{ symbol }}" required>
                        <ul id="search-results" class="list-group position-absolute mt-1" style="z-index: 1000;"></ul>
                    </div>
                    <div class="col-md-3">
                        <input type="date" name="investment_date" class="form-control" value="{{ investment_date }}" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" step="0.01" name="investment_amount" class="form-control" placeholder="Amount Invested (£)" value="{{ investment_amount }}" required>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary">Analyse</button>
                    </div>
                </div>
            </form>

            <!-- Display Error Messages -->
            {% if error_message %}
                <div class="alert alert-danger">{{ error_message }}</div>
            {% endif %}

            <!-- Display Results -->
            {% if result %}
                <div class="alert alert-info">
                    <h3>Investment Analysis for {{ result.symbol }}</h3>
                    <p><strong>Investment Date:</strong> {{ result.investment_date }}</p>
                    <p><strong>Price on Investment Date:</strong> £{{ result.initial_price }}</p>
                    <p><strong>Price Today:</strong> £{{ result.final_price }}</p>
                    <p><strong>Investment Amount:</strong> £{{ result.investment_amount }}</p>
                    <p><strong>Final Value:</strong> £{{ result.final_value }}</p>
                    <p><strong>Percentage Change:</strong> {{ result.percentage_change }}%</p>
                    {% if result.percentage_change > 0 %}
                        <p class="text-success"><strong>Profit:</strong> You would have gained {{ result.percentage_change }}%.</p>
                    {% else %}
                        <p class="text-danger"><strong>Loss:</strong> You would have lost {{ result.percentage_change }}%.</p>
                    {% endif %}
                </div>

                <!-- Display Investment Growth Chart -->
                <h3>Stock Price Growth Since Investment</h3>
                <img src="data:image/png;base64,{{ chart_image }}" class="img-fluid" alt="Investment Growth Chart">
            {% endif %}
        </div>

    {% endif %}

    <script src="{% static 'js/search.js' %}"></script>

{% endblock %}
